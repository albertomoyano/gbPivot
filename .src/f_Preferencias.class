' Gambas class file

Public UsuarioAdmin As String
Public sRefrescar As Result

Public Sub Form_Open()

  f_Preferencias.Title = "Preferencias (usuario: " & m_OnOff_y_Red.UsuarioActual & ")"

  With TableViewUsuarios
    .Header = True
    .Grid = True
    .Columns.Count = 5
    .Columns[0].Title = "id"
    .Columns[0].Width = 0
    .Columns[1].Title = ""
    .Columns[1].Width = 200
    .Columns[2].Title = ""
    .Columns[2].Width = 200
    .Columns[3].Title = ""
    .Columns[3].Width = 200
    .Columns[4].Title = ""
    .Columns[4].Width = 200
  End With

  btnNuevoUsuario.Visible = True
  btnBorrarUsuario.Visible = False
  btnGuardarUsuario.Visible = False
  btnGuardarCambios.Visible = False

  With TableViewProyectos
    .Header = True
    .Grid = True
    .Columns.Count = 5
    .Columns[0].Title = "id"
    .Columns[0].Width = 0
    .Columns[1].Title = ""
    .Columns[1].Width = 200
    .Columns[2].Title = ""
    .Columns[2].Width = 200
    .Columns[3].Title = ""
    .Columns[3].Width = 200
    .Columns[4].Title = ""
    .Columns[4].Width = 200
  End With

  btnNuevoProyecto.Visible = True
  btnBorrarProyecto.Visible = False
  btnGuardarProyecto.Visible = False
  btnGuardarCambiosProyecto.Visible = False

End

Public Sub btnCerrar_Click()

  Me.Close

End

Public Sub ToggleButtonMostrar_Click()
  ' Cambiar visibilidad del TabPanel2 según el estado del botón

  txtClaveAdministrador.Password = Not ToggleButtonMostrar.Value

  If ToggleButtonMostrar.Value Then
    ToggleButtonMostrar.Tooltip = "Ocultar contraseña"
  Else
    ToggleButtonMostrar.Tooltip = "Mostrar contraseña"
  End If

End

Public Sub btnReferescarAdmin_Click()

  ' Intentar obtener el registro de la base de datos
  sRefrescar = m_OnOff_y_Red.meConn.Edit("usuarios_admin", "id=" & txtIdAdmin.Text)

  ' Verificar si se obtuvo una respuesta válida
  If sRefrescar Is Null Then
    Message.Error("Error: No se encontró el registro con ese ID o la conexión falló.")
    Return
  End If

  ' Si todo está bien, proceder a guardar cambios
  guardarCambios()

  ' Verificar si sRefrescar puede hacer update sin error
  Try sRefrescar.Update()
  If Error Then
    Message.Error("Error al actualizar los datos.")
    Return
  End If

  ' Confirmar cambios en la base de datos
  Try m_OnOff_y_Red.meConn.Commit()
  If Error Then
    Message.Error("Error al confirmar los cambios en la base de datos.")
    Return
  End If

  ' Informar al usuario que los cambios se guardaron con éxito
  Message.Info("Los cambios se guardaron con éxito.")

End

Public Sub guardarCambios()

  sRefrescar!id = txtIdAdmin.Text
  sRefrescar!usuario = txtAdministrador.Text
  sRefrescar!clave = txtClaveAdministrador.Text
  sRefrescar!email = txtAdministradorEmail.Text

End

Public Sub txtCierreProyecto_KeyRelease()

  Dim texto As String = txtCierreProyecto.Text
  Dim soloDigitos As String = ""
  Dim textoFormateado As String = ""
  Dim i As Integer
  Dim c As String

  ' Extraer solo los dígitos del texto actual
  For i = 1 To Len(texto)
    c = Mid(texto, i, 1)
    If c >= "0" And c <= "9" Then
      soloDigitos &= c
    End If
  Next

  ' Limitar a máximo 8 dígitos
  If Len(soloDigitos) > 8 Then
    soloDigitos = Left(soloDigitos, 8)
  End If

  ' Formatear automáticamente según la cantidad de dígitos
  Select Case Len(soloDigitos)
    Case 0
      textoFormateado = ""
    Case 1, 2
      textoFormateado = soloDigitos
    Case 3, 4
      textoFormateado = Left(soloDigitos, 2) & "-" & Mid(soloDigitos, 3)
    Case 5, 6, 7, 8
      textoFormateado = Left(soloDigitos, 2) & "-" & Mid(soloDigitos, 3, 2) & "-" & Mid(soloDigitos, 5)
  End Select

  ' Actualizar solo si cambió
  If textoFormateado <> texto Then
    txtCierreProyecto.Text = textoFormateado
    ' Colocar cursor al final
    txtCierreProyecto.Pos = Len(textoFormateado)
  End If

End Sub

' Función adicional para bloquear caracteres no numéricos desde el teclado
Public Sub txtCierreProyecto_KeyPress()
  ' Permitir teclas de control

  If Key.Code = Key.BackSpace Or Key.Code = Key.Delete Or
      Key.Code = Key.Left Or Key.Code = Key.Right Or
      Key.Code = Key.Tab Or Key.Code = Key.Enter Or
      Key.Code = Key.Home Or Key.Code = Key.End Then
    Return
  End If

  ' Solo permitir números
  If Key.Text < "0" Or Key.Text > "9" Then
    Stop Event
  End If

End Sub
