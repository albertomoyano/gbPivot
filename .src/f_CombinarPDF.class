' Gambas class file

Public Sub Form_Open()

  ' Asigna el evento Change de cada TextBox al procedimiento VerificarCampos
  txtTapa_Change()
  txtInterior_Change()
  txtContratapa_Change()

  btnEnsamblar.Visible = False
  ' Llamar a la verificación al inicio por si ya hay algún texto en los TextBox
  VerificarCampos

End

' Evento que se dispara cuando cambia el contenido de txtTapa
Public Sub txtTapa_Change()

  VerificarCampos()

End

' Evento que se dispara cuando cambia el contenido de txtInterior
Public Sub txtInterior_Change()

  VerificarCampos()

End

' Evento que se dispara cuando cambia el contenido de txtContratapa
Public Sub txtContratapa_Change()

  VerificarCampos()

End

Public Sub btnBuscarTapa_Click()

  Dialog.Title = "Seleccionar archivo"
  Dialog.Filter = ["*.pdf", ("Archivos pdf")]
  Dialog.AutoExt = True
  Dialog.Path = File.Dir(FMain.txtProyecto.Text) & "/salidas/pdf/"
  ' Abre el diálogo para seleccionar archivo
  If Dialog.OpenFile() Then
    Return
  Else
    ' Asigna la ruta del archivo seleccionado al TextBox
    txtTapa.Text = Dialog.Path
  Endif

Catch
  Message.Error("No se pudo abrir el archivo")

End

Public Sub btnBuscarInterior_Click()

  Dialog.Title = "Seleccionar archivo"
  Dialog.Filter = ["*.pdf", ("Archivos pdf")]
  Dialog.AutoExt = True
  Dialog.Path = File.Dir(FMain.txtProyecto.Text) & "/salidas/pdf/"
  If Dialog.OpenFile() Then
    Return
  Else
    txtInterior.Text = Dialog.Path
  Endif

Catch
  Message.Error("No se pudo abrir el archivo")

End

Public Sub btnBuscarcontratapa_Click()

  Dialog.Title = "Seleccionar archivo"
  Dialog.Filter = ["*.pdf", ("Archivos pdf")]
  Dialog.AutoExt = True
  Dialog.Path = File.Dir(FMain.txtProyecto.Text) & "/salidas/pdf/"
  If Dialog.OpenFile() Then
    Return
  Else
    txtContratapa.Text = Dialog.Path
  Endif

Catch
  Message.Error("No se pudo abrir el archivo")

End

' Función que verifica si todos los TextBox tienen texto
Public Sub VerificarCampos()

  If txtTapa.Text <> "" And txtInterior.Text <> "" And txtContratapa.Text <> "" Then
    btnEnsamblar.Visible = True
  Else
    btnEnsamblar.Visible = False
  Endif

End

Public Sub btnSalir_Click()

  Me.Close()

End

Public Sub btnEnsamblar_Click()

  FMain.Mouse = Mouse.Wait

  Dim rutaTapa As String = File.RealPath(txtTapa.Text)
  Dim rutaInterior As String = File.RealPath(txtInterior.Text)
  Dim rutaContratapa As String = File.RealPath(txtContratapa.Text)

  Dim rutaTemp As String = File.Dir(FMain.txtProyecto.Text) &/ "salidas/pdf/q.pdf"
  Dim rutaFinal As String = File.Dir(FMain.txtProyecto.Text) &/ "salidas/pdf/web-" & File.BaseName(FMain.txtProyecto.Text) & ".pdf"
  Dim rutaComprimido As String = File.Dir(FMain.txtProyecto.Text) &/ "salidas/pdf/@web-" & File.BaseName(FMain.txtProyecto.Text) & ".pdf"

  Shell "pdftk " & rutaTapa & " " & rutaInterior & " " & rutaContratapa & " cat output " & rutaTemp Wait
  Shell "mv " & rutaTemp & " " & rutaFinal Wait
  Shell "gs -sDEVICE=pdfwrite -dCompatibilityLevel=1.4 -dPDFSETTINGS=/ebook -dNOPAUSE -dQUIET -dBATCH -sOutputFile=" & rutaComprimido & " " & rutaFinal Wait
  Shell "rm " & rutaFinal Wait

  FMain.Mouse = Mouse.Default
  txtTapa.Text = ""
  txtInterior.Text = ""
  txtContratapa.Text = ""

  Message.Info("PDF generado y comprimido correctamente.")

End

Private Sub ValidarRutasPDF()

  Dim rutaTapa As String = txtTapa.Text
  Dim rutaInterior As String = txtInterior.Text
  Dim rutaContratapa As String = txtContratapa.Text

  If File.Exists(rutaTapa) And File.Exists(rutaInterior) And File.Exists(rutaContratapa) Then
    btnEnsamblar.Visible = True
  Else
    btnEnsamblar.Visible = False
  End If

End

Public Sub btnConvertirCOVER_Click()

  ' Obtener la ruta de la tapa
  Dim rutaTapa As String = File.RealPath(txtTapa.Text)

  ' Verificar si rutaTapa es null o está vacía
  If rutaTapa = Null Or rutaTapa = "" Then
    Message.Error("La ruta de la tapa no es válida. Por favor, selecciona un archivo.")
    Return ' Salir de la función si la ruta no es válida
  End If

  ' Definir la ruta de salida para la imagen de la tapa
  Dim salidaCover As String = File.Dir(FMain.txtProyecto.Text) & "/salidas/tapa/cover.png"

  ' Ejecutar el comando Ghostscript para convertir la tapa
  FMain.tvProyecto.Input("gs -sDEVICE=png16m -r300 -dUsePDFXObject -o " & salidaCover & " " & rutaTapa & "\n" & "clear" & "\n")
  Wait 0.2

  ' Mensaje de éxito
  Message.Info("La tapa se ha convertido correctamente en " & salidaCover)

End
